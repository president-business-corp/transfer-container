name: Docker v1

on:
  push:
    branches: [ main ]

env:
  IMAGE: testing-$(date -u +'%Y-%m-%d')
  REGISTRY: docker.pkg.github.com

jobs:
  build-publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Docker v1 Login
        run: echo $TOKEN | docker login -u $USER --password-stdin $REGISTRY
        env:
          TOKEN: ${{ github.token }}
          USER: ${{ github.actor }}

      - name: Docker v1 Build
        run: docker build . -f Dockerfile -t $REGISTRY/${{ github.repository }}/$IMAGE:latest


      - name: Docker v1 Tag
        run: |
          for VERSION in dev edge nightly; do
            docker $REGISTRY/${{ github.repository }}/$IMAGE:latest $REGISTRY/${{ github.repository }}/$IMAGE:$VERSION
          done

      - name: Docker v1 Publish
        run: |
          for VERSION in latest dev edge nightly; do
            docker publish $REGISTRY/${{ github.repository }}/$IMAGE:$VERSION
          done
